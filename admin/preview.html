<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html >
<head>
<title>プレビュー</title>
<meta http-equiv="Content-Script-Type" content="text/javascript">
<meta http-equiv="Content-Style-Type" content="text/css">
<!-- link rel="SHORTCUT ICON" href="http://localhost/geeklog-15/public_html/favicon.ico" -->
<!-- <meta http-equiv="Pragma" content="no-cache"> -->
<link rel="stylesheet" type="text/css" href="http://localhost/geeklog-15/public_html/layout/professional/style.css?dummy=1218438488" title="professional">
<link rel="alternate" type="application/rss+xml" hreflang="en-gb" href="http://localhost/geeklog-15/public_html/backend/geeklog.rss" title="RSS Feed: Geeklog Site">
<link rel="home" href="http://localhost/geeklog-15/public_html/" title="ホーム">
<link rel="search" href="http://localhost/geeklog-15/public_html/search.php" title="検索">
<link rel="service" type="application/atomsvc+xml" href="http://localhost/geeklog-15/public_html/webservices/atom/?introspection" title="Webサービス">
<link rel="microsummary" href="http://localhost/geeklog-15/public_html/index.php?display=microsummary" title="Microsummary"><link rel="stylesheet" type="text/css" href="http://localhost/geeklog-15/public_html/polls/style.css?dummy=1218438488"><meta http-equiv="Content-Script-Type" content="text/javascript">
<script type="text/javascript" src="http://localhost/geeklog-15/public_html/admin/plugins/themedit/selection.js"></script>

<!-- Load Advanced Editor -->
<script type="text/javascript" src="http://localhost/geeklog-15/public_html/fckeditor/fckeditor.js"></script>
<script type="text/javascript">
    var geeklogEditorBaseUrl = 'http://localhost/geeklog-15/public_html';
</script>
<!-- End of Editor Load -->

<!-- Load Common Javascript Libraries -->
<script type="text/javascript" src="http://localhost/geeklog-15/public_html/javascript/common.js"></script>
</head>
<body dir="ltr">
    <div class="header-navigation-container clearfix">
        <ul>
            <li><a href="http://localhost/geeklog-15/public_html/submit.php?type=story">記事投稿</a></li>
<li><a href="http://localhost/geeklog-15/public_html/search.php">検索</a></li>
<li><a href="http://localhost/geeklog-15/public_html/stats.php">サイト情報</a></li>
<li><a href="http://localhost/geeklog-15/public_html/directory.php">記事一覧</a></li>
<li><a href="http://localhost/geeklog-15/public_html/links/index.php">リンク</a></li>
<li><a href="http://localhost/geeklog-15/public_html/polls/index.php">アンケート</a></li>
<li class="last"><a href="http://localhost/geeklog-15/public_html/calendar/index.php">カレンダ</a></li>

        </ul>
    </div>
    <div class="header-logobg-container-inner">
        <a class="header-logo" href="http://localhost/geeklog-15/public_html/">
            <img src="http://localhost/geeklog-15/public_html/layout/professional/images/logo.png" width="151" height="56" alt="Geeklog Site">
        </a>
        <span class="header-slogan">Another Nifty Geeklog Site</span>
    </div>
    <table cellspacing="0" cellpadding="0" style="width:100%;">
        <tr>
            <!-- Start of Left blocks -->
                <td class="block-featured-left" style="vertical-align:top;">
                    <div class="searchform-box">
                        <form class="searchform-elements" action="http://localhost/geeklog-15/public_html/search.php" method="get">
                            <div>
                                <input style="width:95%" type="text" name="query" maxlength="255" value=""><br>
                                <input type="hidden" name="type" value="all">
                                <a href="http://localhost/geeklog-15/public_html/search.php" class="advancedsearch">検索オプション</a>&nbsp;
                                <input type="hidden" name="mode" value="search">
                                <input type="submit" value="検索">
                            </div>
                        </form>
                    </div>
                    <div class="block-bg-left">
                        <div class="block-box blocklist">
    <span class="block-helpicon">
        
    </span>
    <h2>Topics</h2>
    <ul>
<li class="topicoption"><a href="http://localhost/geeklog-15/public_html/index.php">ホーム</a> </li>
<li class="topicoption"><a href="http://localhost/geeklog-15/public_html/index.php?topic=General">General News</a> (0/0)</li>
<li class="topicoption"><a href="http://localhost/geeklog-15/public_html/index.php?topic=Geeklog">Geeklog</a> (4/3)</li>
    </ul>
</div>
<div class="aligncenter">
    <div class="block-divider"></div>
</div><div class="block-box blocklist">
    <span class="block-helpicon">
        
    </span>
    <h2>Admins Only</h2>
    <ul>
<li><a href="http://localhost/geeklog-15/public_html/admin/moderation.php">投稿管理</a> (4)</li>
<li><a href="http://www.geeklog.net/versionchecker.php?version=1.5.0">GLバージョンテスト</a> (1.5.0)</li>
<li><a href="http://localhost/geeklog-15/public_html/admin/plugins/spamx/index.php">Spam-X</a> (N/A)</li>
<li><a href="http://localhost/geeklog-15/public_html/admin/plugins/polls/index.php">アンケート</a> (1)</li>
<li><a href="http://localhost/geeklog-15/public_html/admin/plugins/calendar/index.php">カレンダ</a> (N/A)</li>
<li><a href="http://localhost/geeklog-15/public_html/admin/group.php">グループ</a> (21)</li>
<li><a href="http://localhost/geeklog-15/public_html/admin/mail.php">グループメール</a> (N/A)</li>
<li><a href="http://localhost/geeklog-15/public_html/admin/configuration.php">コンフィギュレーション</a> (6)</li>
<li><a href="http://localhost/geeklog-15/public_html/admin/syndication.php">シンジケーション</a> (1)</li>
<li>テーマエディタ (136)</li>
<li><a href="http://localhost/geeklog-15/public_html/admin/database.php">データベース</a> (N/A)</li>
<li><a href="http://localhost/geeklog-15/public_html/admin/trackback.php">トラックバック</a> (1)</li>
<li><a href="http://localhost/geeklog-15/public_html/docs/index.html">ドキュメント</a> (N/A)</li>
<li><a href="http://localhost/geeklog-15/public_html/admin/block.php">ブロック</a> (9)</li>
<li><a href="http://localhost/geeklog-15/public_html/admin/plugins.php">プラグイン</a> (8)</li>
<li><a href="http://localhost/geeklog-15/public_html/admin/user.php">ユーザ</a> (2)</li>
<li><a href="http://localhost/geeklog-15/public_html/admin/plugins/links/index.php">リンク</a> (1)</li>
<li><a href="http://localhost/geeklog-15/public_html/admin/story.php">記事</a> (4)</li>
<li><a href="http://localhost/geeklog-15/public_html/admin/topic.php">話題</a> (2)</li>
<li><a href="http://localhost/geeklog-15/public_html/admin/plugins/staticpages/index.php">静的ページ</a> (N/A)</li>
    </ul>
</div>
<div class="aligncenter">
    <div class="block-divider"></div>
</div><div class="block-box blocklist">
    <span class="block-helpicon">
        
    </span>
    <h2>User Functions</h2>
    <ul>
<li><a href="http://localhost/geeklog-15/public_html/calendar/index.php?mode=personal">個人カレンダ</a> </li>
<li><a href="http://localhost/geeklog-15/public_html/usersettings.php?mode=edit">マイアカウント</a> </li>
<li><a href="http://localhost/geeklog-15/public_html/users.php?mode=logout">ログアウト</a> </li>
    </ul>
</div>
<div class="aligncenter">
    <div class="block-divider"></div>
</div><div class="block-box-left">
    <span class="block-helpicon">
        
    </span>
    <h2>Events</h2>
-</div>
<div class="aligncenter">
    <div class="block-divider-left"></div>
</div>


                        <div class="block-bg-spreader"></div>
                    </div>
                </td>
                <td class="block-outerborder-left">
                    <div style="background:transparent; width:10px; height:1px;"></div>
                </td>

            <td class="story-container">
                <p class="header-welcomeanddate-text">
                    <b>ようこそ!  Geeklog Site, Admin</b><br>Monday, August 11 2008 @ 04:08 PM JST
                </p>

                <!-- START OF CONTENT AREA -->
<div class="story-featured">
    <span class="story-icons">
        <a href="http://localhost/geeklog-15/public_html/profiles.php?sid=welcome&amp;what=emailstory"><img src="http://localhost/geeklog-15/public_html/layout/professional/images/mail.png" alt="記事を友人にメールする" title="友だちに記事をメールする"></a>
        <a href="http://localhost/geeklog-15/public_html/article.php?story=welcome&amp;mode=print" rel="nofollow"><img src="http://localhost/geeklog-15/public_html/layout/professional/images/print.png" alt="印刷用画面" title="印刷用ページ"></a>
        
        <a href="http://localhost/geeklog-15/public_html/admin/story.php?mode=edit&amp;sid=welcome"><img src="http://localhost/geeklog-15/public_html/layout/professional/images/edit.png" alt="編集" title="編集"></a>
    </span>
    <h1><a href="http://localhost/geeklog-15/public_html/article.php?story=welcome" class="non-ul">Welcome to Geeklog!</a></h1>
    <div class="story-information">
        <p>Sunday, July 13 2008 @ 01:52 PM JST</p>
        <p>投稿者: <a href="http://localhost/geeklog-15/public_html/users.php?mode=profile&amp;uid=2" class="storybyline">Admin</a></p>
        <p>閲覧件数 101</p>
    </div>
    <div class="story-body">
        <a href="http://localhost/geeklog-15/public_html/index.php?topic=Geeklog" rel="category tag"><img src="http://localhost/geeklog-15/public_html/images/topics/topic_gl.gif" class="floatright" alt="Geeklog" title="Geeklog"></a><p>Welcome and let me be the first to congratulate you on installing Geeklog. Please take the time to read everything in the <a href="docs/index.html">docs directory</a>. Geeklog now has enhanced, user-based security.  You should thoroughly understand how these work before you run a production Geeklog Site.</p><p>To log into your new Geeklog site, please use this account:</p><p>Username: <b>Admin</b><br />Password: <b>password</b></p><p><b>And don't forget to <a href="/usersettings.php?mode=edit">change your password</a> after logging in!</b></p>
    </div>
    <div class="story-footer">
        <p></p>
        <p> <a href="http://localhost/geeklog-15/public_html/comment.php?sid=welcome&amp;pid=0&amp;type=article" rel="nofollow">コメント投稿</a></p>
        <p>コメント (0件) トラックバック (0件)</p>
    </div>
</div>
<div class="block-divider"> </div>
<div class="story">
    <span class="story-icons">
        <a href="http://localhost/geeklog-15/public_html/profiles.php?sid=20080722230307779&amp;what=emailstory"><img src="http://localhost/geeklog-15/public_html/layout/professional/images/mail.png" alt="記事を友人にメールする" title="友だちに記事をメールする"></a>
        <a href="http://localhost/geeklog-15/public_html/article.php?story=20080722230307779&amp;mode=print" rel="nofollow"><img src="http://localhost/geeklog-15/public_html/layout/professional/images/print.png" alt="印刷用画面" title="印刷用ページ"></a>
        
        <a href="http://localhost/geeklog-15/public_html/admin/story.php?mode=edit&amp;sid=20080722230307779"><img src="http://localhost/geeklog-15/public_html/layout/professional/images/edit.png" alt="編集" title="編集"></a>
    </span>
    <h1><a href="http://localhost/geeklog-15/public_html/article.php?story=20080722230307779" class="non-ul">テスト</a></h1>
    <div class="story-information">
        <p>Tuesday, July 22 2008 @ 11:03 PM JST</p>
        <p>投稿者: <a href="http://localhost/geeklog-15/public_html/users.php?mode=profile&amp;uid=3" class="storybyline">test</a></p>
        <p>閲覧件数 0</p>
    </div>
    <div class="story-body">
        <a href="http://localhost/geeklog-15/public_html/index.php?topic=Geeklog" rel="category tag"><img src="http://localhost/geeklog-15/public_html/images/topics/topic_gl.gif" class="floatright" alt="Geeklog" title="Geeklog"></a>&lt;?php<br />
<br />
/* Reminder: always indent with 4 spaces (no tabs). */<br />
// +---------------------------------------------------------------------------+<br />
// | Geeklog 1.5                                                               |<br />
// +---------------------------------------------------------------------------+<br />
// | users.php                                                                 |<br />
// |                                                                           |<br />
// | User authentication module.                                               |<br />
// +---------------------------------------------------------------------------+<br />
// | Copyright (C) 2000-2008 by the following authors:                         |<br />
// |                                                                           |<br />
// | Authors: Tony Bibbs        - tony AT tonybibbs DOT com                    |<br />
// |          Mark Limburg      - mlimburg AT users DOT sourceforge DOT net    |<br />
// |          Jason Whittenburg - jwhitten AT securitygeeks DOT com            |<br />
// |          Dirk Haun         - dirk AT haun-online DOT de                   |<br />
// +---------------------------------------------------------------------------+<br />
// |                                                                           |<br />
// | This program is free software; you can redistribute it and/or             |<br />
// | modify it under the terms of the GNU General Public License               |<br />
// | as published by the Free Software Foundation; either version 2            |<br />
// | of the License, or (at your option) any later version.                    |<br />
// |                                                                           |<br />
// | This program is distributed in the hope that it will be useful,           |<br />
// | but WITHOUT ANY WARRANTY; without even the implied warranty of            |<br />
// | MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the             |<br />
// | GNU General Public License for more details.                              |<br />
// |                                                                           |<br />
// | You should have received a copy of the GNU General Public License         |<br />
// | along with this program; if not, write to the Free Software Foundation,   |<br />
// | Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.           |<br />
// |                                                                           |<br />
// +---------------------------------------------------------------------------+<br />
//<br />
// &#36;Id: users.php,v 1.167 2008/03/15 08:57:15 dhaun Exp &#36;<br />
<br />
/**<br />
* This file handles user authentication<br />
*<br />
* @author   Tony Bibbs &lt;tony@tonybibbs.com&gt;<br />
* @author   Mark Limburg &lt;mlimburg@users.sourceforge.net&gt;<br />
* @author   Jason Whittenburg<br />
*<br />
*/<br />
<br />
/**<br />
* Geeklog common function library<br />
*/<br />
require_once 'lib-common.php';<br />
require_once &#36;_CONF['path_system'] . 'lib-user.php';<br />
&#36;VERBOSE = false;<br />
<br />
// Uncomment the line below if you need to debug the HTTP variables being passed<br />
// to the script.  This will sometimes cause errors but it will allow you to see<br />
// the data being passed in a POST operation<br />
<br />
// echo COM_debug(&#36;_POST);<br />
<br />
/**<br />
* Shows a profile for a user<br />
*<br />
* This grabs the user profile for a given user and displays it<br />
*<br />
* @param    int     &#36;user   User ID of profile to get<br />
* @param    int     &#36;msg    Message to display (if != 0)<br />
* @return   string          HTML for user profile page<br />
*<br />
*/<br />
function userprofile (&#36;user, &#36;msg = 0)<br />
&#123;<br />
    global &#36;_CONF, &#36;_TABLES, &#36;_USER, &#36;LANG01, &#36;LANG04, &#36;LANG09, &#36;LANG28, &#36;LANG_LOGIN;<br />
<br />
    &#36;retval = '';<br />
    if (empty (&#36;_USER['username']) &amp;&amp;<br />
        ((&#36;_CONF['loginrequired'] == 1) || (&#36;_CONF['profileloginrequired'] == 1))) &#123;<br />
        &#36;retval .= COM_siteHeader ('menu', &#36;LANG_LOGIN[1]);<br />
        &#36;retval .= COM_startBlock (&#36;LANG_LOGIN[1], '',<br />
                           COM_getBlockTemplate ('_msg_block', 'header'));<br />
        &#36;login = new Template(&#36;_CONF['path_layout'] . 'submit');<br />
        &#36;login-&gt;set_file (array ('login'=&gt;'submitloginrequired.thtml'));<br />
        &#36;login-&gt;set_var ( 'xhtml', XHTML );<br />
        &#36;login-&gt;set_var ('login_message', &#36;LANG_LOGIN[2]);<br />
        &#36;login-&gt;set_var ('site_url', &#36;_CONF['site_url']);<br />
        &#36;login-&gt;set_var ('site_admin_url', &#36;_CONF['site_admin_url']);<br />
        &#36;login-&gt;set_var ('layout_url', &#36;_CONF['layout_url']);<br />
        &#36;login-&gt;set_var ('lang_login', &#36;LANG_LOGIN[3]);<br />
        &#36;login-&gt;set_var ('lang_newuser', &#36;LANG_LOGIN[4]);<br />
        &#36;login-&gt;parse ('output', 'login');<br />
        &#36;retval .= &#36;login-&gt;finish (&#36;login-&gt;get_var('output'));<br />
        &#36;retval .= COM_endBlock (COM_getBlockTemplate ('_msg_block', 'footer'));<br />
        &#36;retval .= COM_siteFooter ();<br />
<br />
        return &#36;retval;<br />
    &#125;<br />
<br />
    &#36;result = DB_query (&quot;SELECT &#123;&#36;_TABLES['users']&#125;.uid,username,fullname,regdate,homepage,about,location,pgpkey,photo,email,status FROM &#123;&#36;_TABLES['userinfo']&#125;,&#123;&#36;_TABLES['users']&#125; WHERE &#123;&#36;_TABLES['userinfo']&#125;.uid = &#123;&#36;_TABLES['users']&#125;.uid AND &#123;&#36;_TABLES['users']&#125;.uid = &#36;user&quot;);<br />
    &#36;nrows = DB_numRows (&#36;result);<br />
    if (&#36;nrows == 0) &#123; // no such user<br />
        return COM_refresh (&#36;_CONF['site_url'] . '/index.php');<br />
    &#125;<br />
    &#36;A = DB_fetchArray (&#36;result);<br />
<br />
    if (&#36;A['status'] == USER_ACCOUNT_DISABLED &amp;&amp; !SEC_hasRights ('user.edit')) &#123;<br />
        COM_displayMessageAndAbort (30, '', 403, 'Forbidden');<br />
    &#125;<br />
<br />
    &#36;display_name = htmlspecialchars(COM_getDisplayName(&#36;user, &#36;A['username'],<br />
                                                        &#36;A['fullname']));<br />
<br />
    &#36;retval .= COM_siteHeader ('menu', &#36;LANG04[1] . ' ' . &#36;display_name);<br />
    if (&#36;msg &gt; 0) &#123;<br />
        &#36;retval .= COM_showMessage (&#36;msg);<br />
    &#125;<br />
<br />
    // format date/time to user preference<br />
    &#36;curtime = COM_getUserDateTimeFormat (&#36;A['regdate']);<br />
    &#36;A['regdate'] = &#36;curtime[0];<br />
<br />
    &#36;user_templates = new Template (&#36;_CONF['path_layout'] . 'users');<br />
    &#36;user_templates-&gt;set_file (array ('profile' =&gt; 'profile.thtml',<br />
                                      'row'     =&gt; 'commentrow.thtml',<br />
                                      'strow'   =&gt; 'storyrow.thtml'));<br />
    &#36;user_templates-&gt;set_var ('xhtml', XHTML);<br />
    &#36;user_templates-&gt;set_var ('site_url', &#36;_CONF['site_url']);<br />
    &#36;user_templates-&gt;set_var ('start_block_userprofile',<br />
            COM_startBlock (&#36;LANG04[1] . ' ' . &#36;display_name));<br />
    &#36;user_templates-&gt;set_var ('end_block', COM_endBlock ());<br />
    &#36;user_templates-&gt;set_var ('lang_username', &#36;LANG04[2]);<br />
<br />
    if (&#36;_CONF['show_fullname'] == 1) &#123;<br />
        if (empty (&#36;A['fullname'])) &#123;<br />
            &#36;username = &#36;A['username'];<br />
            &#36;fullname = '';<br />
        &#125; else &#123;<br />
            &#36;username = &#36;A['fullname'];<br />
            &#36;fullname = &#36;A['username'];<br />
        &#125;<br />
    &#125; else &#123;<br />
        &#36;username = &#36;A['username'];<br />
        &#36;fullname = &#36;A['fullname'];<br />
    &#125;<br />
    &#36;username = htmlspecialchars(&#36;username);<br />
    &#36;fullname = htmlspecialchars(&#36;fullname);<br />
<br />
    if (&#36;A['status'] == USER_ACCOUNT_DISABLED) &#123;<br />
        &#36;username = sprintf ('&lt;s title=&quot;%s&quot;&gt;%s&lt;/s&gt;', &#36;LANG28[42], &#36;username);<br />
        if (!empty (&#36;fullname)) &#123;<br />
            &#36;fullname = sprintf ('&lt;s title=&quot;%s&quot;&gt;%s&lt;/s&gt;', &#36;LANG28[42], &#36;fullname);<br />
        &#125;<br />
    &#125;<br />
<br />
    &#36;user_templates-&gt;set_var ('username', &#36;username);<br />
    &#36;user_templates-&gt;set_var ('user_fullname', &#36;fullname);<br />
<br />
    if (SEC_hasRights ('user.edit')) &#123;<br />
        global &#36;_IMAGE_TYPE, &#36;LANG_ADMIN;<br />
<br />
        &#36;edit_icon = '&lt;img src=&quot;' . &#36;_CONF['layout_url'] . '/images/edit.'<br />
                   . &#36;_IMAGE_TYPE . '&quot; alt=&quot;' . &#36;LANG_ADMIN['edit']<br />
                   . '&quot; title=&quot;' . &#36;LANG_ADMIN['edit'] . '&quot;' . XHTML . '&gt;';<br />
        &#36;edit_link_url = COM_createLink(&#36;edit_icon,<br />
            &quot;&#123;&#36;_CONF['site_admin_url']&#125;/user.php?mode=edit&amp;amp;uid=&#123;&#36;A['uid']&#125;&quot;);<br />
        &#36;user_templates-&gt;set_var ('edit_icon', &#36;edit_icon);<br />
        &#36;user_templates-&gt;set_var ('edit_link', &#36;edit_link_url);<br />
        &#36;user_templates-&gt;set_var ('user_edit', &#36;edit_link_url);<br />
    &#125;<br />
<br />
    if (isset (&#36;A['photo']) &amp;&amp; empty (&#36;A['photo'])) &#123;<br />
        &#36;A['photo'] = '(none)'; // user does not have a photo<br />
    &#125;<br />
    &#36;photo = USER_getPhoto (&#36;user, &#36;A['photo'], &#36;A['email'], -1);<br />
    &#36;user_templates-&gt;set_var ('user_photo', &#36;photo);<br />
<br />
    &#36;user_templates-&gt;set_var ('lang_membersince', &#36;LANG04[67]);<br />
    &#36;user_templates-&gt;set_var ('user_regdate', &#36;A['regdate']);<br />
    &#36;user_templates-&gt;set_var ('lang_email', &#36;LANG04[5]);<br />
    &#36;user_templates-&gt;set_var ('user_id', &#36;user);<br />
    &#36;user_templates-&gt;set_var ('lang_sendemail', &#36;LANG04[81]);<br />
    &#36;user_templates-&gt;set_var ('lang_homepage', &#36;LANG04[6]);<br />
    &#36;user_templates-&gt;set_var ('user_homepage', COM_killJS (&#36;A['homepage']));<br />
    &#36;user_templates-&gt;set_var ('lang_location', &#36;LANG04[106]);<br />
    &#36;user_templates-&gt;set_var ('user_location', strip_tags (&#36;A['location']));<br />
    &#36;user_templates-&gt;set_var ('lang_bio', &#36;LANG04[7]);<br />
    &#36;user_templates-&gt;set_var ('user_bio', nl2br (stripslashes (&#36;A['about'])));<br />
    &#36;user_templates-&gt;set_var ('lang_pgpkey', &#36;LANG04[8]);<br />
    &#36;user_templates-&gt;set_var ('user_pgp', nl2br (&#36;A['pgpkey']));<br />
    &#36;user_templates-&gt;set_var ('start_block_last10stories',<br />
            COM_startBlock (&#36;LANG04[82] . ' ' . &#36;display_name));<br />
    &#36;user_templates-&gt;set_var ('start_block_last10comments',<br />
            COM_startBlock(&#36;LANG04[10] . ' ' . &#36;display_name));<br />
    &#36;user_templates-&gt;set_var ('start_block_postingstats',<br />
            COM_startBlock (&#36;LANG04[83] . ' ' . &#36;display_name));<br />
    &#36;user_templates-&gt;set_var ('lang_title', &#36;LANG09[16]);<br />
    &#36;user_templates-&gt;set_var ('lang_date', &#36;LANG09[17]);<br />
<br />
    // for alternative layouts: use these as headlines instead of block titles<br />
    &#36;user_templates-&gt;set_var ('headline_last10stories', &#36;LANG04[82]);<br />
    &#36;user_templates-&gt;set_var ('headline_last10comments', &#36;LANG04[10]);<br />
    &#36;user_templates-&gt;set_var ('headline_postingstats', &#36;LANG04[83]);<br />
<br />
    &#36;result = DB_query (&quot;SELECT tid FROM &#123;&#36;_TABLES['topics']&#125;&quot;<br />
            . COM_getPermSQL ());<br />
    &#36;nrows = DB_numRows (&#36;result);<br />
    &#36;tids = array ();<br />
    for (&#36;i = 0; &#36;i &lt; &#36;nrows; &#36;i++) &#123;<br />
        &#36;T = DB_fetchArray (&#36;result);<br />
        &#36;tids[] = &#36;T['tid'];<br />
    &#125;<br />
    &#36;topics = &quot;'&quot; . implode (&quot;','&quot;, &#36;tids) . &quot;'&quot;;<br />
<br />
    // list of last 10 stories by this user<br />
    if (sizeof (&#36;tids) &gt; 0) &#123;<br />
        &#36;sql = &quot;SELECT sid,title,UNIX_TIMESTAMP(date) AS unixdate FROM &#123;&#36;_TABLES['stories']&#125; WHERE (uid = &#36;user) AND (draft_flag = 0) AND (date &lt;= NOW()) AND (tid IN (&#36;topics))&quot; . COM_getPermSQL ('AND');<br />
        &#36;sql .= &quot; ORDER BY unixdate DESC LIMIT 10&quot;;<br />
        &#36;result = DB_query (&#36;sql);<br />
        &#36;nrows = DB_numRows (&#36;result);<br />
    &#125; else &#123;<br />
        &#36;nrows = 0;<br />
    &#125;<br />
    if (&#36;nrows &gt; 0) &#123;<br />
        for (&#36;i = 0; &#36;i &lt; &#36;nrows; &#36;i++) &#123;<br />
            &#36;C = DB_fetchArray (&#36;result);<br />
            &#36;user_templates-&gt;set_var ('cssid', (&#36;i % 2) + 1);<br />
            &#36;user_templates-&gt;set_var ('row_number', (&#36;i + 1) . '.');<br />
            &#36;articleUrl = COM_buildUrl (&#36;_CONF['site_url']<br />
                                        . '/article.php?story=' . &#36;C['sid']);<br />
            &#36;user_templates-&gt;set_var ('article_url', &#36;articleUrl);<br />
            &#36;C['title'] = str_replace ('&#36;', '&amp;#36;', &#36;C['title']);<br />
            &#36;user_templates-&gt;set_var ('story_title',<br />
                COM_createLink(<br />
                    stripslashes (&#36;C['title']),<br />
                    &#36;articleUrl,<br />
                    array ('class'=&gt;'b'))<br />
            );<br />
            &#36;storytime = COM_getUserDateTimeFormat (&#36;C['unixdate']);<br />
            &#36;user_templates-&gt;set_var ('story_date', &#36;storytime[0]);<br />
            &#36;user_templates-&gt;parse ('story_row', 'strow', true);<br />
        &#125;<br />
    &#125; else &#123;<br />
        &#36;user_templates-&gt;set_var ('story_row',<br />
                                  '&lt;tr&gt;&lt;td&gt;' . &#36;LANG01[37] . '&lt;/td&gt;&lt;/tr&gt;');<br />
    &#125;<br />
<br />
    // list of last 10 comments by this user<br />
    &#36;sidArray = array();<br />
    if (sizeof (&#36;tids) &gt; 0) &#123;<br />
        // first, get a list of all stories the current visitor has access to<br />
        &#36;sql = &quot;SELECT sid FROM &#123;&#36;_TABLES['stories']&#125; WHERE (draft_flag = 0) AND (date &lt;= NOW()) AND (tid IN (&#36;topics))&quot; . COM_getPermSQL ('AND');<br />
        &#36;result = DB_query(&#36;sql);<br />
        &#36;numsids = DB_numRows(&#36;result);<br />
        for (&#36;i = 1; &#36;i &lt;= &#36;numsids; &#36;i++) &#123;<br />
            &#36;S = DB_fetchArray (&#36;result);<br />
            &#36;sidArray[] = &#36;S['sid'];<br />
        &#125;<br />
    &#125;<br />
<br />
    &#36;sidList = implode(&quot;', '&quot;,&#36;sidArray);<br />
    &#36;sidList = &quot;'&#36;sidList'&quot;;<br />
<br />
    // then, find all comments by the user in those stories<br />
    &#36;sql = &quot;SELECT sid,title,cid,UNIX_TIMESTAMP(date) AS unixdate FROM &#123;&#36;_TABLES['comments']&#125; WHERE (uid = &#36;user) GROUP BY sid,title,cid,UNIX_TIMESTAMP(date)&quot;;<br />
<br />
    // SQL NOTE:  Using a HAVING clause is usually faster than a where if the<br />
    // field is part of the select<br />
    // if (!empty (&#36;sidList)) &#123;<br />
    //     &#36;sql .= &quot; AND (sid in (&#36;sidList))&quot;;<br />
    // &#125;<br />
    if (!empty (&#36;sidList)) &#123;<br />
        &#36;sql .= &quot; HAVING sid in (&#36;sidList)&quot;;<br />
    &#125;<br />
    &#36;sql .= &quot; ORDER BY unixdate DESC LIMIT 10&quot;;<br />
<br />
    &#36;result = DB_query(&#36;sql);<br />
    &#36;nrows = DB_numRows(&#36;result);<br />
    if (&#36;nrows &gt; 0) &#123;<br />
        for (&#36;i = 0; &#36;i &lt; &#36;nrows; &#36;i++) &#123;<br />
            &#36;C = DB_fetchArray (&#36;result);<br />
            &#36;user_templates-&gt;set_var ('cssid', (&#36;i % 2) + 1);<br />
            &#36;user_templates-&gt;set_var ('row_number', (&#36;i + 1) . '.');<br />
            &#36;C['title'] = str_replace ('&#36;', '&amp;#36;', &#36;C['title']);<br />
            &#36;comment_url = &#36;_CONF['site_url'] .<br />
                    '/comment.php?mode=view&amp;amp;cid=' . &#36;C['cid'];<br />
            &#36;user_templates-&gt;set_var ('comment_title',<br />
                COM_createLink(<br />
                    stripslashes (&#36;C['title']),<br />
                    &#36;comment_url,<br />
                    array ('class'=&gt;'b'))<br />
            );<br />
            &#36;commenttime = COM_getUserDateTimeFormat (&#36;C['unixdate']);<br />
            &#36;user_templates-&gt;set_var ('comment_date', &#36;commenttime[0]);<br />
            &#36;user_templates-&gt;parse ('comment_row', 'row', true);<br />
        &#125;<br />
    &#125; else &#123;<br />
        &#36;user_templates-&gt;set_var('comment_row','&lt;tr&gt;&lt;td&gt;' . &#36;LANG01[29] . '&lt;/td&gt;&lt;/tr&gt;');<br />
    &#125;<br />
<br />
    // posting stats for this user<br />
    &#36;user_templates-&gt;set_var ('lang_number_stories', &#36;LANG04[84]);<br />
    &#36;sql = &quot;SELECT COUNT(*) AS count FROM &#123;&#36;_TABLES['stories']&#125; WHERE (uid = &#36;user) AND (draft_flag = 0) AND (date &lt;= NOW())&quot; . COM_getPermSQL ('AND');<br />
    &#36;result = DB_query(&#36;sql);<br />
    &#36;N = DB_fetchArray (&#36;result);<br />
    &#36;user_templates-&gt;set_var ('number_stories', COM_numberFormat (&#36;N['count']));<br />
    &#36;user_templates-&gt;set_var ('lang_number_comments', &#36;LANG04[85]);<br />
    &#36;sql = &quot;SELECT COUNT(*) AS count FROM &#123;&#36;_TABLES['comments']&#125; WHERE (uid = &#36;user)&quot;;<br />
    if (!empty (&#36;sidList)) &#123;<br />
        &#36;sql .= &quot; AND (sid in (&#36;sidList))&quot;;<br />
    &#125;<br />
    &#36;result = DB_query (&#36;sql);<br />
    &#36;N = DB_fetchArray (&#36;result);<br />
    &#36;user_templates-&gt;set_var ('number_comments', COM_numberFormat(&#36;N['count']));<br />
    &#36;user_templates-&gt;set_var ('lang_all_postings_by',<br />
                              &#36;LANG04[86] . ' ' . &#36;display_name);<br />
<br />
    // Call custom registration function if enabled and exists<br />
    if (&#36;_CONF['custom_registration'] &amp;&amp; function_exists ('CUSTOM_userDisplay') ) &#123;<br />
        &#36;user_templates-&gt;set_var ('customfields', CUSTOM_userDisplay (&#36;user));<br />
    &#125;<br />
    PLG_profileVariablesDisplay (&#36;user, &#36;user_templates);<br />
<br />
    &#36;user_templates-&gt;parse ('output', 'profile');<br />
    &#36;retval .= &#36;user_templates-&gt;finish (&#36;user_templates-&gt;get_var ('output'));<br />
<br />
    &#36;retval .= PLG_profileBlocksDisplay (&#36;user);<br />
    &#36;retval .= COM_siteFooter ();<br />
<br />
    return &#36;retval;<br />
&#125;<br />
<br />
/**<br />
* Emails password to a user<br />
*<br />
* This will email the given user their password.<br />
*<br />
* @param    string      &#36;username       Username for which to get and email password<br />
* @param    int         &#36;msg            Message number of message to show when done<br />
* @return   string      Optionally returns the HTML for the default form if the user info can't be found<br />
*<br />
*/<br />
function emailpassword (&#36;username, &#36;msg = 0)<br />
&#123;<br />
    global &#36;_CONF, &#36;_TABLES, &#36;LANG04;<br />
<br />
    &#36;retval = '';<br />
<br />
    &#36;username = addslashes (&#36;username);<br />
    // don't retrieve any remote users!<br />
    &#36;result = DB_query (&quot;SELECT uid,email,status FROM &#123;&#36;_TABLES['users']&#125; WHERE username = '&#36;username' AND ((remoteservice is null) OR (remoteservice = ''))&quot;);<br />
    &#36;nrows = DB_numRows (&#36;result);<br />
    if (&#36;nrows == 1) &#123;<br />
        &#36;A = DB_fetchArray (&#36;result);<br />
        if ((&#36;_CONF['usersubmission'] == 1) &amp;&amp; (&#36;A['status'] == USER_ACCOUNT_AWAITING_APPROVAL))<br />
        &#123;<br />
            return COM_refresh (&#36;_CONF['site_url'] . '/index.php?msg=48');<br />
        &#125;<br />
<br />
        &#36;mailresult = USER_createAndSendPassword (&#36;username, &#36;A['email'], &#36;A['uid']);<br />
<br />
        if (&#36;mailresult == false) &#123;<br />
            &#36;retval = COM_refresh (&quot;&#123;&#36;_CONF['site_url']&#125;/index.php?msg=85&quot;);<br />
        &#125; else if (&#36;msg) &#123;<br />
            &#36;retval = COM_refresh (&quot;&#123;&#36;_CONF['site_url']&#125;/index.php?msg=&#36;msg&quot;);<br />
<br />
        &#125; else &#123;<br />
            &#36;retval = COM_refresh (&quot;&#123;&#36;_CONF['site_url']&#125;/index.php?msg=1&quot;);<br />
        &#125;<br />
    &#125; else &#123;<br />
        &#36;retval = COM_siteHeader ('menu', &#36;LANG04[17])<br />
                . defaultform (&#36;LANG04[17])<br />
                . COM_siteFooter ();<br />
    &#125;<br />
<br />
    return &#36;retval;<br />
&#125;<br />
<br />
/**<br />
* User request for a new password - send email with a link and request id<br />
*<br />
* @param username string   name of user who requested the new password<br />
* @param msg      int      index of message to display (if any)<br />
* @return         string   form or meta redirect<br />
*<br />
*/<br />
function requestpassword (&#36;username, &#36;msg = 0)<br />
&#123;<br />
    global &#36;_CONF, &#36;_TABLES, &#36;LANG04;<br />
<br />
    &#36;retval = '';<br />
<br />
    // no remote users!<br />
    &#36;result = DB_query (&quot;SELECT uid,email,passwd,status FROM &#123;&#36;_TABLES['users']&#125; WHERE username = '&#36;username' AND ((remoteservice IS NULL) OR (remoteservice=''))&quot;);<br />
    &#36;nrows = DB_numRows (&#36;result);<br />
    if (&#36;nrows == 1) &#123;<br />
        &#36;A = DB_fetchArray (&#36;result);<br />
        if ((&#36;_CONF['usersubmission'] == 1) &amp;&amp; (&#36;A['status'] == USER_ACCOUNT_AWAITING_APPROVAL)) &#123;<br />
            return COM_refresh (&#36;_CONF['site_url'] . '/index.php?msg=48');<br />
        &#125;<br />
        &#36;reqid = substr (md5 (uniqid (rand (), 1)), 1, 16);<br />
        DB_change (&#36;_TABLES['users'], 'pwrequestid', &quot;&#36;reqid&quot;,<br />
                   'uid', &#36;A['uid']);<br />
<br />
        &#36;mailtext = sprintf (&#36;LANG04[88], &#36;username);<br />
        &#36;mailtext .= &#36;_CONF['site_url'] . '/users.php?mode=newpwd&amp;uid=' . &#36;A['uid'] . '&amp;rid=' . &#36;reqid . &quot;nn&quot;;<br />
        &#36;mailtext .= &#36;LANG04[89];<br />
        &#36;mailtext .= &quot;&#123;&#36;_CONF['site_name']&#125;n&quot;;<br />
        &#36;mailtext .= &quot;&#123;&#36;_CONF['site_url']&#125;n&quot;;<br />
<br />
        &#36;subject = &#36;_CONF['site_name'] . ': ' . &#36;LANG04[16];<br />
        if (&#36;_CONF['site_mail'] !== &#36;_CONF['noreply_mail']) &#123;<br />
            &#36;mailfrom = &#36;_CONF['noreply_mail'];<br />
            global &#36;LANG_LOGIN;<br />
            &#36;mailtext .= LB . LB . &#36;LANG04[159];<br />
        &#125; else &#123;<br />
            &#36;mailfrom = &#36;_CONF['site_mail'];<br />
        &#125;<br />
        COM_mail (&#36;A['email'], &#36;subject, &#36;mailtext, &#36;mailfrom);<br />
<br />
        if (&#36;msg) &#123;<br />
            &#36;retval .= COM_refresh (&#36;_CONF['site_url'] . &quot;/index.php?msg=&#36;msg&quot;);<br />
        &#125; else &#123;<br />
            &#36;retval .= COM_refresh (&#36;_CONF['site_url'] . '/index.php');<br />
        &#125;<br />
        COM_updateSpeedlimit ('password');<br />
    &#125; else &#123;<br />
        &#36;retval .= COM_siteHeader ('menu', &#36;LANG04[17])<br />
                . defaultform (&#36;LANG04[17]) . COM_siteFooter ();<br />
    &#125;<br />
<br />
    return &#36;retval;<br />
&#125;<br />
<br />
/**<br />
* Display a form where the user can enter a new password.<br />
*<br />
* @param uid       int      user id<br />
* @param requestid string   request id for password change<br />
* @return          string   new password form<br />
*<br />
*/<br />
function newpasswordform (&#36;uid, &#36;requestid)<br />
&#123;<br />
    global &#36;_CONF, &#36;_TABLES, &#36;LANG04;<br />
<br />
    &#36;pwform = new Template (&#36;_CONF['path_layout'] . 'users');<br />
    &#36;pwform-&gt;set_file (array ('newpw' =&gt; 'newpassword.thtml'));<br />
    &#36;pwform-&gt;set_var ( 'xhtml', XHTML );<br />
    &#36;pwform-&gt;set_var ('site_url', &#36;_CONF['site_url']);<br />
    &#36;pwform-&gt;set_var ('layout_url', &#36;_CONF['layout_url']);<br />
<br />
    &#36;pwform-&gt;set_var ('user_id', &#36;uid);<br />
    &#36;pwform-&gt;set_var ('user_name', DB_getItem (&#36;_TABLES['users'], 'username',<br />
                                               &quot;uid = '&#123;&#36;uid&#125;'&quot;));<br />
    &#36;pwform-&gt;set_var ('request_id', &#36;requestid);<br />
<br />
    &#36;pwform-&gt;set_var ('lang_explain', &#36;LANG04[90]);<br />
    &#36;pwform-&gt;set_var ('lang_username', &#36;LANG04[2]);<br />
    &#36;pwform-&gt;set_var ('lang_newpassword', &#36;LANG04[4]);<br />
    &#36;pwform-&gt;set_var ('lang_newpassword_conf', &#36;LANG04[108]);<br />
    &#36;pwform-&gt;set_var ('lang_setnewpwd', &#36;LANG04[91]);<br />
<br />
    &#36;retval = COM_startBlock (&#36;LANG04[92]);<br />
    &#36;retval .= &#36;pwform-&gt;finish (&#36;pwform-&gt;parse ('output', 'newpw'));<br />
    &#36;retval .= COM_endBlock ();<br />
<br />
    return &#36;retval;<br />
&#125;<br />
<br />
/**<br />
* Creates a user<br />
*<br />
* Creates a user with the give username and email address<br />
*<br />
* @param    string      &#36;username       username to create user for<br />
* @param    string      &#36;email          email address to assign to user<br />
* @param    string      &#36;email_conf     confirmation email address check<br />
* @return   string      HTML for the form again if error occurs, otherwise nothing.<br />
*<br />
*/<br />
function createuser (&#36;username, &#36;email, &#36;email_conf)<br />
&#123;<br />
    global &#36;_CONF, &#36;_TABLES, &#36;LANG01, &#36;LANG04;<br />
<br />
    &#36;retval = '';<br />
<br />
    &#36;username = trim (&#36;username);<br />
    &#36;email = trim (&#36;email);<br />
    &#36;email_conf = trim (&#36;email_conf);<br />
<br />
    if (!isset (&#36;_CONF['disallow_domains'])) &#123;<br />
        &#36;_CONF['disallow_domains'] = '';<br />
    &#125;<br />
<br />
    if (COM_isEmail (&#36;email) &amp;&amp; !empty (&#36;username) &amp;&amp; (&#36;email === &#36;email_conf)<br />
            &amp;&amp; !USER_emailMatches (&#36;email, &#36;_CONF['disallow_domains'])) &#123;<br />
<br />
        &#36;ucount = DB_count (&#36;_TABLES['users'], 'username',<br />
                            addslashes (&#36;username));<br />
        &#36;ecount = DB_count (&#36;_TABLES['users'], 'email', addslashes (&#36;email));<br />
<br />
        if (&#36;ucount == 0 AND &#36;ecount == 0) &#123;<br />
<br />
            // For Geeklog, it would be okay to create this user now. But check<br />
            // with a custom userform first, if one exists.<br />
            if (&#36;_CONF['custom_registration'] &amp;&amp;<br />
                    function_exists ('CUSTOM_userCheck')) &#123;<br />
                &#36;msg = CUSTOM_userCheck (&#36;username, &#36;email);<br />
                if (!empty (&#36;msg)) &#123;<br />
                    // no, it's not okay with the custom userform<br />
                    &#36;retval = COM_siteHeader ('menu')<br />
                            . CUSTOM_userForm (&#36;msg)<br />
                            . COM_siteFooter ();<br />
<br />
                    return &#36;retval;<br />
                &#125;<br />
            &#125;<br />
<br />
            // Let plugins have a chance to decide what to do before creating the user, return errors.<br />
            &#36;msg = PLG_itemPreSave ('registration', &#36;username);<br />
            if (!empty (&#36;msg)) &#123;<br />
                &#36;retval .= COM_siteHeader ('menu', &#36;LANG04[22]);<br />
                if (&#36;_CONF['custom_registration'] &amp;&amp; function_exists ('CUSTOM_userForm')) &#123;<br />
                    &#36;retval .= CUSTOM_userForm (&#36;msg);<br />
                &#125; else &#123;<br />
                    &#36;retval .= newuserform (&#36;msg);<br />
                &#125;<br />
                &#36;retval .= COM_siteFooter();<br />
<br />
                return &#36;retval;<br />
            &#125;<br />
<br />
            &#36;uid = USER_createAccount (&#36;username, &#36;email);<br />
<br />
            if (&#36;_CONF['usersubmission'] == 1) &#123;<br />
                if (DB_getItem (&#36;_TABLES['users'], 'status', &quot;uid = &#36;uid&quot;)<br />
                        == USER_ACCOUNT_AWAITING_APPROVAL) &#123;<br />
                    &#36;retval = COM_refresh (&#36;_CONF['site_url']<br />
                                           . '/index.php?msg=48');<br />
                &#125; else &#123;<br />
                    &#36;retval = emailpassword (&#36;username, 1);<br />
                &#125;<br />
            &#125; else &#123;<br />
                &#36;retval = emailpassword (&#36;username, 1);<br />
            &#125;<br />
<br />
            return &#36;retval;<br />
        &#125; else &#123;<br />
            &#36;retval .= COM_siteHeader ('menu', &#36;LANG04[22]);<br />
            if (&#36;_CONF['custom_registration'] &amp;&amp;<br />
                    function_exists ('CUSTOM_userForm')) &#123;<br />
                &#36;retval .= CUSTOM_userForm (&#36;LANG04[19]);<br />
            &#125; else &#123;<br />
                &#36;retval .= newuserform (&#36;LANG04[19]);<br />
            &#125;<br />
            &#36;retval .= COM_siteFooter ();<br />
        &#125;<br />
    &#125; else if (&#36;email !== &#36;email_conf) &#123;<br />
        &#36;msg = &#36;LANG04[125];<br />
        &#36;retval .= COM_siteHeader ('menu', &#36;LANG04[22]);<br />
        if (&#36;_CONF['custom_registration'] &amp;&amp; function_exists('CUSTOM_userForm')) &#123;<br />
            &#36;retval .= CUSTOM_userForm (&#36;msg);<br />
        &#125; else &#123;<br />
            &#36;retval .= newuserform (&#36;msg);<br />
        &#125;<br />
        &#36;retval .= COM_siteFooter();<br />
    &#125; else &#123; // invalid username or email address<br />
<br />
        if (empty (&#36;username)) &#123;<br />
            &#36;msg = &#36;LANG01[32]; // invalid username<br />
        &#125; else &#123;<br />
            &#36;msg = &#36;LANG04[18]; // invalid email address<br />
        &#125;<br />
        &#36;retval .= COM_siteHeader ('menu', &#36;LANG04[22]);<br />
        if (&#36;_CONF['custom_registration'] &amp;&amp; function_exists('CUSTOM_userForm')) &#123;<br />
            &#36;retval .= CUSTOM_userForm (&#36;msg);<br />
        &#125; else &#123;<br />
            &#36;retval .= newuserform (&#36;msg);<br />
        &#125;<br />
        &#36;retval .= COM_siteFooter();<br />
    &#125;<br />
<br />
    return &#36;retval;<br />
&#125;<br />
<br />
/**<br />
* Shows the user login form after failed attempts to either login or access a page<br />
* requiring login.<br />
*<br />
* @return   string      HTML for login form<br />
*<br />
*/<br />
function loginform (&#36;hide_forgotpw_link = false, &#36;statusmode = -1)<br />
&#123;<br />
    global &#36;_CONF, &#36;LANG01, &#36;LANG04;<br />
<br />
    &#36;retval = '';<br />
<br />
    &#36;user_templates = new Template (&#36;_CONF['path_layout'] . 'users');<br />
    &#36;user_templates-&gt;set_file('login', 'loginform.thtml');<br />
    &#36;user_templates-&gt;set_var( 'xhtml', XHTML );<br />
    &#36;user_templates-&gt;set_var('site_url', &#36;_CONF['site_url']);<br />
    if (&#36;statusmode == 0) &#123;<br />
        &#36;user_templates-&gt;set_var('start_block_loginagain', COM_startBlock(&#36;LANG04[114]));<br />
        &#36;user_templates-&gt;set_var('lang_message', &#36;LANG04[115]);<br />
    &#125; elseif (&#36;statusmode == 2) &#123;<br />
        &#36;user_templates-&gt;set_var('start_block_loginagain', COM_startBlock(&#36;LANG04[116]));<br />
        &#36;user_templates-&gt;set_var('lang_message', &#36;LANG04[117]);<br />
    &#125; else &#123;<br />
        &#36;user_templates-&gt;set_var('start_block_loginagain', COM_startBlock(&#36;LANG04[65]));<br />
        if (&#36;_CONF['disable_new_user_registration']) &#123;<br />
            &#36;user_templates-&gt;set_var('lang_newreglink', '');<br />
        &#125; else &#123;<br />
            &#36;user_templates-&gt;set_var('lang_newreglink', &#36;LANG04[123]);<br />
        &#125;<br />
        &#36;user_templates-&gt;set_var('lang_message', &#36;LANG04[66]);<br />
    &#125;<br />
<br />
    &#36;user_templates-&gt;set_var('lang_username', &#36;LANG04[2]);<br />
    &#36;user_templates-&gt;set_var('lang_password', &#36;LANG01[57]);<br />
    if (&#36;hide_forgotpw_link) &#123;<br />
        &#36;user_templates-&gt;set_var('lang_forgetpassword', '');<br />
    &#125; else &#123;<br />
        &#36;user_templates-&gt;set_var('lang_forgetpassword', &#36;LANG04[25]);<br />
    &#125;<br />
    &#36;user_templates-&gt;set_var('lang_login', &#36;LANG04[80]);<br />
    &#36;user_templates-&gt;set_var('end_block', COM_endBlock());<br />
<br />
    // 3rd party remote authentification.<br />
    if (&#36;_CONF['user_login_method']['3rdparty'] &amp;&amp; !&#36;_CONF['usersubmission']) &#123;<br />
        &#36;modules = SEC_collectRemoteAuthenticationModules();<br />
        if (count(&#36;modules) == 0) &#123;<br />
            &#36;user_templates-&gt;set_var('services', '');<br />
        &#125; else &#123;<br />
            if (!&#36;_CONF['user_login_method']['standard'] &amp;&amp;<br />
                    (count(&#36;modules) == 1)) &#123;<br />
                &#36;select = '&lt;input type=&quot;hidden&quot; name=&quot;service&quot; value=&quot;'<br />
                        . &#36;modules[0] . '&quot;' . XHTML . '&gt;' . &#36;modules[0];<br />
            &#125; else &#123;<br />
                // Build select<br />
                &#36;select = '&lt;select name=&quot;service&quot;&gt;';<br />
                if (&#36;_CONF['user_login_method']['standard']) &#123;<br />
                    &#36;select .= '&lt;option value=&quot;&quot;&gt;' .  &#36;_CONF['site_name']<br />
                            . '&lt;/option&gt;';<br />
                &#125;<br />
                foreach (&#36;modules as &#36;service) &#123;<br />
                    &#36;select .= '&lt;option value=&quot;' . &#36;service . '&quot;&gt;' . &#36;service<br />
                            . '&lt;/option&gt;';<br />
                &#125;<br />
                &#36;select .= '&lt;/select&gt;';<br />
            &#125;<br />
<br />
            &#36;user_templates-&gt;set_file('services', 'services.thtml');<br />
            &#36;user_templates-&gt;set_var('lang_service', &#36;LANG04[121]);<br />
            &#36;user_templates-&gt;set_var('select_service', &#36;select);<br />
            &#36;user_templates-&gt;parse('output', 'services');<br />
            &#36;user_templates-&gt;set_var('services',<br />
                   &#36;user_templates-&gt;finish(&#36;user_templates-&gt;get_var('output')));<br />
        &#125;<br />
    &#125; else &#123;<br />
        &#36;user_templates-&gt;set_var('services', '');<br />
    &#125;<br />
<br />
    // OpenID remote authentification.<br />
    if (&#36;_CONF['user_login_method']['openid'] &amp;&amp; !&#36;_CONF['usersubmission']) &#123;<br />
        &#36;user_templates-&gt;set_file('openid_login', '../loginform_openid.thtml');<br />
        &#36;user_templates-&gt;set_var('lang_openid_login', &#36;LANG01[128]);<br />
        &#36;user_templates-&gt;set_var('input_field_size', 40);<br />
        &#36;app_url = isset(&#36;_SERVER['SCRIPT_URI']) ? &#36;_SERVER['SCRIPT_URI'] : 'http://'.&#36;_SERVER['HTTP_HOST'].&#36;_SERVER['PHP_SELF'];<br />
        &#36;user_templates-&gt;set_var('app_url', &#36;app_url);<br />
        &#36;user_templates-&gt;parse('output', 'openid_login');<br />
        &#36;user_templates-&gt;set_var('openid_login',<br />
            &#36;user_templates-&gt;finish(&#36;user_templates-&gt;get_var('output')));<br />
    &#125; else &#123;<br />
        &#36;user_templates-&gt;set_var('openid_login', '');<br />
    &#125;<br />
<br />
    &#36;user_templates-&gt;parse('output', 'login');<br />
<br />
    &#36;retval .= &#36;user_templates-&gt;finish(&#36;user_templates-&gt;get_var('output'));<br />
<br />
    return &#36;retval;<br />
&#125;<br />
<br />
/**<br />
* Shows the user registration form<br />
*<br />
* @param    int     &#36;msg        message number to show<br />
* @param    string  &#36;referrer   page to send user to after registration<br />
* @return   string  HTML for user registration page<br />
*/<br />
function newuserform (&#36;msg = '')<br />
&#123;<br />
    global &#36;_CONF, &#36;LANG04;<br />
<br />
    &#36;retval = '';<br />
<br />
    if (!empty (&#36;msg)) &#123;<br />
        &#36;retval .= COM_startBlock (&#36;LANG04[21], '',<br />
                           COM_getBlockTemplate ('_msg_block', 'header'))<br />
                . &#36;msg<br />
                . COM_endBlock (COM_getBlockTemplate ('_msg_block', 'footer'));<br />
    &#125;<br />
    &#36;user_templates = new Template(&#36;_CONF['path_layout'] . 'users');<br />
    &#36;user_templates-&gt;set_file('regform', 'registrationform.thtml');<br />
    &#36;user_templates-&gt;set_var( 'xhtml', XHTML );<br />
    &#36;user_templates-&gt;set_var('site_url', &#36;_CONF['site_url']);<br />
    &#36;user_templates-&gt;set_var('site_admin_url', &#36;_CONF['site_admin_url']);<br />
    &#36;user_templates-&gt;set_var('layout_url', &#36;_CONF['layout_url']);<br />
    &#36;user_templates-&gt;set_var('start_block', COM_startBlock(&#36;LANG04[22]));<br />
    &#36;user_templates-&gt;set_var('lang_instructions', &#36;LANG04[23]);<br />
    &#36;user_templates-&gt;set_var('lang_username', &#36;LANG04[2]);<br />
    &#36;user_templates-&gt;set_var('lang_email', &#36;LANG04[5]);<br />
    &#36;user_templates-&gt;set_var('lang_email_conf', &#36;LANG04[124]);<br />
    &#36;user_templates-&gt;set_var('lang_warning', &#36;LANG04[24]);<br />
    &#36;user_templates-&gt;set_var('lang_register', &#36;LANG04[27]);<br />
    PLG_templateSetVars ('registration', &#36;user_templates);<br />
    &#36;user_templates-&gt;set_var('end_block', COM_endBlock());<br />
<br />
    &#36;username = '';<br />
    if (!empty (&#36;_POST['username'])) &#123;<br />
        &#36;username = COM_applyFilter (&#36;_POST['username']);<br />
    &#125;<br />
    &#36;user_templates-&gt;set_var ('username', &#36;username);<br />
<br />
    &#36;email = '';<br />
    if (!empty (&#36;_POST['email'])) &#123;<br />
        &#36;email = COM_applyFilter (&#36;_POST['email']);<br />
    &#125;<br />
    &#36;user_templates-&gt;set_var ('email', &#36;email);<br />
<br />
    &#36;email_conf = '';<br />
    if (!empty (&#36;_POST['email_conf'])) &#123;<br />
        &#36;email_conf = COM_applyFilter (&#36;_POST['email_conf']);<br />
    &#125;<br />
    &#36;user_templates-&gt;set_var ('email_conf', &#36;email_conf);<br />
<br />
<br />
    &#36;user_templates-&gt;parse('output', 'regform');<br />
    &#36;retval .= &#36;user_templates-&gt;finish(&#36;user_templates-&gt;get_var('output'));<br />
<br />
    return &#36;retval;<br />
&#125;<br />
<br />
/**<br />
* Shows the password retrieval form<br />
*<br />
* @return   string  HTML for form used to retrieve user's password<br />
*<br />
*/<br />
function getpasswordform()<br />
&#123;<br />
    global &#36;_CONF, &#36;LANG04;<br />
<br />
    &#36;retval = '';<br />
<br />
    &#36;user_templates = new Template(&#36;_CONF['path_layout'] . 'users');<br />
    &#36;user_templates-&gt;set_file('form', 'getpasswordform.thtml');<br />
    &#36;user_templates-&gt;set_var( 'xhtml', XHTML );<br />
    &#36;user_templates-&gt;set_var('site_url', &#36;_CONF['site_url']);<br />
    &#36;user_templates-&gt;set_var('site_admin_url', &#36;_CONF['site_admin_url']);<br />
    &#36;user_templates-&gt;set_var('layout_url', &#36;_CONF['layout_url']);<br />
    &#36;user_templates-&gt;set_var('start_block_forgetpassword', COM_startBlock(&#36;LANG04[25]));<br />
    &#36;user_templates-&gt;set_var('lang_instructions', &#36;LANG04[26]);<br />
    &#36;user_templates-&gt;set_var('lang_username', &#36;LANG04[2]);<br />
    &#36;user_templates-&gt;set_var('lang_email', &#36;LANG04[5]);<br />
    &#36;user_templates-&gt;set_var('lang_emailpassword', &#36;LANG04[28]);<br />
    &#36;user_templates-&gt;set_var('end_block', COM_endBlock());<br />
    &#36;user_templates-&gt;parse('output', 'form');<br />
<br />
    &#36;retval .= &#36;user_templates-&gt;finish(&#36;user_templates-&gt;get_var('output'));<br />
<br />
    return &#36;retval;<br />
&#125;<br />
<br />
/**<br />
* Account does not exist - show both the login and register forms<br />
*<br />
* @param    string  &#36;msg        message to display if one is needed<br />
* @return   string  HTML for form<br />
*<br />
*/<br />
function defaultform (&#36;msg)<br />
&#123;<br />
    global &#36;LANG04;<br />
<br />
    &#36;retval = '';<br />
<br />
    if (!empty (&#36;msg)) &#123;<br />
        &#36;retval .= COM_startBlock (&#36;LANG04[21], '',<br />
                           COM_getBlockTemplate ('_msg_block', 'header'))<br />
                . &#36;msg<br />
                . COM_endBlock (COM_getBlockTemplate ('_msg_block', 'footer'));<br />
    &#125;<br />
<br />
    &#36;retval .= loginform (true);<br />
<br />
    &#36;retval .= newuserform ();<br />
<br />
    &#36;retval .= getpasswordform ();<br />
<br />
    return &#36;retval;<br />
&#125;<br />
<br />
/**<br />
* Display message after a login error<br />
*<br />
* @param    int     &#36;msg            message number for custom handler<br />
* @param    string  &#36;message_title  title for the message box<br />
* @param    string  &#36;message_text   text of the message box<br />
* @return   void                    function does not return!<br />
*<br />
*/<br />
function displayLoginErrorAndAbort(&#36;msg, &#36;message_title, &#36;message_text)<br />
&#123;<br />
    global &#36;_CONF;<br />
<br />
    if (&#36;_CONF['custom_registration'] &amp;&amp;<br />
            function_exists('CUSTOM_loginErrorHandler')) &#123;<br />
        // Typically this will be used if you have a custom main site page<br />
        // and need to control the login process<br />
        &#36;display .= CUSTOM_loginErrorHandler(&#36;msg);<br />
    &#125; else &#123;<br />
        &#36;retval .= COM_siteHeader('menu', &#36;message_title)<br />
                . COM_startBlock(&#36;message_title, '',<br />
                                 COM_getBlockTemplate('_msg_block', 'header'))<br />
                . &#36;message_text<br />
                . COM_endBlock(COM_getBlockTemplate('_msg_block', 'footer'))<br />
                . COM_siteFooter();<br />
<br />
        header(&#36;_SERVER['SERVER_PROTOCOL'] . ' 403 Forbidden');<br />
        header('Status: 403 Forbidden');<br />
        echo &#36;retval;<br />
    &#125;<br />
<br />
    // don't return<br />
    exit();<br />
&#125;<br />
<br />
<br />
// MAIN<br />
if (isset (&#36;_REQUEST['mode'])) &#123;<br />
    &#36;mode = &#36;_REQUEST['mode'];<br />
&#125; else &#123;<br />
    &#36;mode = '';<br />
&#125;<br />
<br />
&#36;display = '';<br />
<br />
switch (&#36;mode) &#123;<br />
case 'logout':<br />
    if (!empty (&#36;_USER['uid']) AND &#36;_USER['uid'] &gt; 1) &#123;<br />
        SESS_endUserSession (&#36;_USER['uid']);<br />
        PLG_logoutUser (&#36;_USER['uid']);<br />
    &#125;<br />
    setcookie (&#36;_CONF['cookie_session'], '', time() - 10000,<br />
               &#36;_CONF['cookie_path'], &#36;_CONF['cookiedomain'],<br />
               &#36;_CONF['cookiesecure']);<br />
    setcookie (&#36;_CONF['cookie_password'], '', time() - 10000,<br />
               &#36;_CONF['cookie_path'], &#36;_CONF['cookiedomain'],<br />
               &#36;_CONF['cookiesecure']);<br />
    setcookie (&#36;_CONF['cookie_name'], '', time() - 10000,<br />
               &#36;_CONF['cookie_path'], &#36;_CONF['cookiedomain'],<br />
               &#36;_CONF['cookiesecure']);<br />
    &#36;display = COM_refresh(&#36;_CONF['site_url'] . '/index.php?msg=8');<br />
    break;<br />
<br />
case 'profile':<br />
    &#36;uid = COM_applyFilter (&#36;_GET['uid'], true);<br />
    if (is_numeric (&#36;uid) &amp;&amp; (&#36;uid &gt; 0)) &#123;<br />
        &#36;msg = 0;<br />
        if (isset (&#36;_GET['msg'])) &#123;<br />
            &#36;msg = COM_applyFilter (&#36;_GET['msg'], true);<br />
        &#125;<br />
        &#36;display .= userprofile (&#36;uid, &#36;msg);<br />
    &#125; else &#123;<br />
        &#36;display .= COM_refresh (&#36;_CONF['site_url'] . '/index.php');<br />
    &#125;<br />
    break;<br />
<br />
case 'user':<br />
    &#36;username = COM_applyFilter (&#36;_GET['username']);<br />
    if (!empty (&#36;username)) &#123;<br />
        &#36;username = addslashes (&#36;username);<br />
        &#36;uid = DB_getItem (&#36;_TABLES['users'], 'uid', &quot;username = '&#36;username'&quot;);<br />
        if (&#36;uid &gt; 1) &#123;<br />
            &#36;display .= userprofile (&#36;uid);<br />
        &#125; else &#123;<br />
            &#36;display .= COM_refresh (&#36;_CONF['site_url'] . '/index.php');<br />
        &#125;<br />
    &#125; else &#123;<br />
        &#36;display .= COM_refresh (&#36;_CONF['site_url'] . '/index.php');<br />
    &#125;<br />
    break;<br />
<br />
case 'create':<br />
    if (&#36;_CONF['disable_new_user_registration']) &#123;<br />
        &#36;display .= COM_siteHeader ('menu', &#36;LANG04[22]);<br />
        &#36;display .= COM_startBlock (&#36;LANG04[22], '',<br />
                            COM_getBlockTemplate ('_msg_block', 'header'))<br />
                 . &#36;LANG04[122]<br />
                 . COM_endBlock (COM_getBlockTemplate ('_msg_block', 'footer'));<br />
        &#36;display .= COM_siteFooter ();<br />
    &#125; else &#123;<br />
        &#36;email = COM_applyFilter (&#36;_POST['email']);<br />
        &#36;email_conf = COM_applyFilter (&#36;_POST['email_conf']);<br />
        &#36;display .= createuser(COM_applyFilter (&#36;_POST['username']), &#36;email, &#36;email_conf);<br />
    &#125;<br />
    break;<br />
<br />
case 'getpassword':<br />
    &#36;display .= COM_siteHeader ('menu', &#36;LANG04[25]);<br />
    if (&#36;_CONF['passwordspeedlimit'] == 0) &#123;<br />
        &#36;_CONF['passwordspeedlimit'] = 300; // 5 minutes<br />
    &#125;<br />
    COM_clearSpeedlimit (&#36;_CONF['passwordspeedlimit'], 'password');<br />
    &#36;last = COM_checkSpeedlimit ('password');<br />
    if (&#36;last &gt; 0) &#123;<br />
        &#36;display .= COM_startBlock (&#36;LANG12[26], '',<br />
                            COM_getBlockTemplate ('_msg_block', 'header'))<br />
                 . sprintf (&#36;LANG04[93], &#36;last, &#36;_CONF['passwordspeedlimit'])<br />
                 . COM_endBlock (COM_getBlockTemplate ('_msg_block', 'footer'));<br />
    &#125; else &#123;<br />
        &#36;display .= getpasswordform ();<br />
    &#125;<br />
    &#36;display .= COM_siteFooter ();<br />
    break;<br />
<br />
case 'newpwd':<br />
    &#36;uid = COM_applyFilter (&#36;_GET['uid'], true);<br />
    &#36;reqid = COM_applyFilter (&#36;_GET['rid']);<br />
    if (!empty (&#36;uid) &amp;&amp; is_numeric (&#36;uid) &amp;&amp; (&#36;uid &gt; 0) &amp;&amp;<br />
            !empty (&#36;reqid) &amp;&amp; (strlen (&#36;reqid) == 16)) &#123;<br />
        &#36;valid = DB_count (&#36;_TABLES['users'], array ('uid', 'pwrequestid'),<br />
                           array (&#36;uid, &#36;reqid));<br />
        if (&#36;valid == 1) &#123;<br />
            &#36;display .= COM_siteHeader ('menu', &#36;LANG04[92]);<br />
            &#36;display .= newpasswordform (&#36;uid, &#36;reqid);<br />
            &#36;display .= COM_siteFooter ();<br />
        &#125; else &#123; // request invalid or expired<br />
            &#36;display .= COM_siteHeader ('menu', &#36;LANG04[25]);<br />
            &#36;display .= COM_showMessage (54);<br />
            &#36;display .= getpasswordform ();<br />
            &#36;display .= COM_siteFooter ();<br />
        &#125;<br />
    &#125; else &#123;<br />
        // this request doesn't make sense - ignore it<br />
        &#36;display = COM_refresh (&#36;_CONF['site_url']);<br />
    &#125;<br />
    break;<br />
<br />
case 'setnewpwd':<br />
    if ( (empty (&#36;_POST['passwd']))<br />
            or (&#36;_POST['passwd'] != &#36;_POST['passwd_conf']) ) &#123;<br />
        &#36;display = COM_refresh (&#36;_CONF['site_url']<br />
                 . '/users.php?mode=newpwd&amp;amp;uid=' . &#36;_POST['uid']<br />
                 . '&amp;amp;rid=' . &#36;_POST['rid']);<br />
    &#125; else &#123;<br />
        &#36;uid = COM_applyFilter (&#36;_POST['uid'], true);<br />
        &#36;reqid = COM_applyFilter (&#36;_POST['rid']);<br />
        if (!empty (&#36;uid) &amp;&amp; is_numeric (&#36;uid) &amp;&amp; (&#36;uid &gt; 0) &amp;&amp;<br />
                !empty (&#36;reqid) &amp;&amp; (strlen (&#36;reqid) == 16)) &#123;<br />
            &#36;valid = DB_count (&#36;_TABLES['users'], array ('uid', 'pwrequestid'),<br />
                               array (&#36;uid, &#36;reqid));<br />
            if (&#36;valid == 1) &#123;<br />
                &#36;passwd = SEC_encryptPassword(&#36;_POST['passwd']);<br />
                DB_change (&#36;_TABLES['users'], 'passwd', &quot;&#36;passwd&quot;,<br />
                           &quot;uid&quot;, &#36;uid);<br />
                DB_delete (&#36;_TABLES['sessions'], 'uid', &#36;uid);<br />
                DB_change (&#36;_TABLES['users'], 'pwrequestid', &quot;NULL&quot;,<br />
                           'uid', &#36;uid);<br />
                &#36;display = COM_refresh (&#36;_CONF['site_url'] . '/users.php?msg=53');<br />
            &#125; else &#123; // request invalid or expired<br />
                &#36;display .= COM_siteHeader ('menu', &#36;LANG04[25]);<br />
                &#36;display .= COM_showMessage (54);<br />
                &#36;display .= getpasswordform ();<br />
                &#36;display .= COM_siteFooter ();<br />
            &#125;<br />
        &#125; else &#123;<br />
            // this request doesn't make sense - ignore it<br />
            &#36;display = COM_refresh (&#36;_CONF['site_url']);<br />
        &#125;<br />
    &#125;<br />
    break;<br />
<br />
case 'emailpasswd':<br />
    if (&#36;_CONF['passwordspeedlimit'] == 0) &#123;<br />
        &#36;_CONF['passwordspeedlimit'] = 300; // 5 minutes<br />
    &#125;<br />
    COM_clearSpeedlimit (&#36;_CONF['passwordspeedlimit'], 'password');<br />
    &#36;last = COM_checkSpeedlimit ('password');<br />
    if (&#36;last &gt; 0) &#123;<br />
        &#36;display .= COM_siteHeader ('menu', &#36;LANG12[26])<br />
                 . COM_startBlock (&#36;LANG12[26], '',<br />
                           COM_getBlockTemplate ('_msg_block', 'header'))<br />
                 . sprintf (&#36;LANG04[93], &#36;last, &#36;_CONF['passwordspeedlimit'])<br />
                 . COM_endBlock (COM_getBlockTemplate ('_msg_block', 'footer'))<br />
                 . COM_siteFooter ();<br />
    &#125; else &#123;<br />
        &#36;username = COM_applyFilter (&#36;_POST['username']);<br />
        &#36;email = COM_applyFilter (&#36;_POST['email']);<br />
        if (empty (&#36;username) &amp;&amp; !empty (&#36;email)) &#123;<br />
            &#36;username = DB_getItem (&#36;_TABLES['users'], 'username',<br />
                                    &quot;email = '&#36;email' AND ((remoteservice IS NULL) OR (remoteservice = ''))&quot;);<br />
        &#125;<br />
        if (!empty (&#36;username)) &#123;<br />
            &#36;display .= requestpassword (&#36;username, 55);<br />
        &#125; else &#123;<br />
            &#36;display = COM_refresh (&#36;_CONF['site_url']<br />
                                    . '/users.php?mode=getpassword');<br />
        &#125;<br />
    &#125;<br />
    break;<br />
<br />
case 'new':<br />
    &#36;display .= COM_siteHeader ('menu', &#36;LANG04[22]);<br />
    if (&#36;_CONF['disable_new_user_registration']) &#123;<br />
        &#36;display .= COM_startBlock (&#36;LANG04[22], '',<br />
                            COM_getBlockTemplate ('_msg_block', 'header'))<br />
                 . &#36;LANG04[122]<br />
                 . COM_endBlock (COM_getBlockTemplate ('_msg_block', 'footer'));<br />
    &#125; else &#123;<br />
        // Call custom registration and account record create function<br />
        // if enabled and exists<br />
        if (&#36;_CONF['custom_registration'] AND (function_exists('CUSTOM_userForm'))) &#123;<br />
            &#36;display .= CUSTOM_userForm();<br />
        &#125; else &#123;<br />
            &#36;display .= newuserform();<br />
        &#125;<br />
    &#125;<br />
    &#36;display .= COM_siteFooter();<br />
    break;<br />
<br />
default:<br />
<br />
    // prevent dictionary attacks on passwords<br />
    COM_clearSpeedlimit(&#36;_CONF['login_speedlimit'], 'login');<br />
    if (COM_checkSpeedlimit('login', &#36;_CONF['login_attempts']) &gt; 0) &#123;<br />
        displayLoginErrorAndAbort(82, &#36;LANG12[26], &#36;LANG04[112]);<br />
    &#125;<br />
<br />
    &#36;loginname = '';<br />
    if (isset (&#36;_POST['loginname'])) &#123;<br />
        &#36;loginname = COM_applyFilter (&#36;_POST['loginname']);<br />
    &#125;<br />
    &#36;passwd = '';<br />
    if (isset (&#36;_POST['passwd'])) &#123;<br />
        &#36;passwd = &#36;_POST['passwd'];<br />
    &#125;<br />
    &#36;service = '';<br />
    if (isset (&#36;_POST['service'])) &#123;<br />
        &#36;service = COM_applyFilter(&#36;_POST['service']);<br />
    &#125;<br />
    &#36;uid = '';<br />
    if (!empty(&#36;loginname) &amp;&amp; !empty(&#36;passwd) &amp;&amp; empty(&#36;service)) &#123;<br />
        if (empty(&#36;service) &amp;&amp; &#36;_CONF['user_login_method']['standard']) &#123;<br />
            &#36;status = SEC_authenticate(&#36;loginname, &#36;passwd, &#36;uid);<br />
        &#125; else &#123;<br />
            &#36;status = -1;<br />
        &#125;<br />
<br />
    &#125; elseif (( &#36;_CONF['usersubmission'] == 0) &amp;&amp; &#36;_CONF['user_login_method']['3rdparty'] &amp;&amp; (&#36;service != '')) &#123;<br />
        /* Distributed Authentication */<br />
        //pass &#36;loginname by ref so we can change it ;-)<br />
        &#36;status = SEC_remoteAuthentication(&#36;loginname, &#36;passwd, &#36;service, &#36;uid);<br />
<br />
    &#125; elseif ((&#36;_CONF['usersubmission'] == 0) &amp;&amp; &#36;_CONF['user_login_method']['openid'] &amp;&amp; (isset(&#36;_GET['openid_login']) &amp;&amp; (&#36;_GET['openid_login'] == '1'))) &#123;<br />
        // Here we go with the handling of OpenID authentification.<br />
<br />
        &#36;query = array_merge(&#36;_GET, &#36;_POST);<br />
<br />
        if (isset(&#36;query['identity_url']) &amp;&amp;<br />
                (&#36;query['identity_url'] != 'http://')) &#123;<br />
            &#36;property = sprintf('%x', crc32(&#36;query['identity_url']));<br />
            COM_clearSpeedlimit(&#36;_CONF['login_speedlimit'], 'openid');<br />
            if (COM_checkSpeedlimit('openid', &#36;_CONF['login_attempts'],<br />
                                    &#36;property) &gt; 0) &#123;<br />
                displayLoginErrorAndAbort(82, &#36;LANG12[26], &#36;LANG04[112]);<br />
            &#125;<br />
        &#125;<br />
<br />
        require_once &#36;_CONF['path_system'] . 'classes/openidhelper.class.php';<br />
<br />
        &#36;consumer = new SimpleConsumer();<br />
        &#36;handler = new SimpleActionHandler(&#36;query, &#36;consumer);<br />
<br />
        if (isset(&#36;query['identity_url']) &amp;&amp; &#36;query['identity_url'] != 'http://') &#123;<br />
            &#36;identity_url = &#36;query['identity_url'];<br />
            &#36;ret = &#36;consumer-&gt;find_identity_info(&#36;identity_url);<br />
            if (!&#36;ret) &#123;<br />
                COM_updateSpeedlimit('login');<br />
                &#36;property = sprintf('%x', crc32(&#36;query['identity_url']));<br />
                COM_updateSpeedlimit('openid', &#36;property);<br />
                COM_errorLog('Unable to find an OpenID server for the identity URL ' . &#36;identity_url);<br />
                echo COM_refresh(&#36;_CONF['site_url'] . '/users.php?msg=89');<br />
                exit;<br />
            &#125; else &#123;<br />
                // Found identity server info.<br />
                list(&#36;identity_url, &#36;server_id, &#36;server_url) = &#36;ret;<br />
<br />
                // Redirect the user-agent to the OpenID server<br />
                // which we are requesting information from.<br />
                header('Location: ' . &#36;consumer-&gt;handle_request(<br />
                        &#36;server_id, &#36;server_url,<br />
                        oidUtil::append_args(&#36;_CONF['site_url'] . '/users.php',<br />
                            array('openid_login' =&gt; '1',<br />
                                  'open_id' =&gt; &#36;identity_url)), // Return to.<br />
                        &#36;_CONF['site_url'], // Trust root.<br />
                        null,<br />
                        &quot;email,nickname,fullname&quot;)); // Required fields.<br />
            &#125;<br />
        &#125; elseif (isset(&#36;query['openid.mode']) || isset(&#36;query['openid_mode'])) &#123;<br />
            &#36;openid_mode = '';<br />
            if (isset(&#36;query['openid.mode'])) &#123;<br />
                &#36;openid_mode = &#36;query['openid.mode'];<br />
            &#125; else if(isset(&#36;query['openid_mode'])) &#123;<br />
                &#36;openid_mode = &#36;query['openid_mode'];<br />
            &#125;<br />
            if (&#36;openid_mode == 'cancel') &#123;<br />
                COM_updateSpeedlimit('login');<br />
                echo COM_refresh(&#36;_CONF['site_url'] . '/users.php?msg=90');<br />
                exit;<br />
            &#125; else &#123;<br />
               &#36;openid = &#36;handler-&gt;getOpenID();<br />
               &#36;req = new ConsumerRequest(&#36;openid, &#36;query, 'GET');<br />
               &#36;response = &#36;consumer-&gt;handle_response(&#36;req);<br />
               &#36;response-&gt;doAction(&#36;handler);<br />
            &#125;<br />
        &#125; else &#123;<br />
            COM_updateSpeedlimit('login');<br />
            echo COM_refresh(&#36;_CONF['site_url'] . '/users.php?msg=91');<br />
            exit;<br />
        &#125;<br />
    &#125; else &#123;<br />
        &#36;status = -1;<br />
    &#125;<br />
<br />
    if (&#36;status == USER_ACCOUNT_ACTIVE) &#123; // logged in AOK.<br />
        DB_change(&#36;_TABLES['users'],'pwrequestid',&quot;NULL&quot;,'uid',&#36;uid);<br />
        &#36;userdata = SESS_getUserDataFromId(&#36;uid);<br />
        &#36;_USER = &#36;userdata;<br />
        &#36;sessid = SESS_newSession(&#36;_USER['uid'], &#36;_SERVER['REMOTE_ADDR'], &#36;_CONF['session_cookie_timeout'], &#36;_CONF['cookie_ip']);<br />
        SESS_setSessionCookie(&#36;sessid, &#36;_CONF['session_cookie_timeout'], &#36;_CONF['cookie_session'], &#36;_CONF['cookie_path'], &#36;_CONF['cookiedomain'], &#36;_CONF['cookiesecure']);<br />
        PLG_loginUser (&#36;_USER['uid']);<br />
<br />
        // Now that we handled session cookies, handle longterm cookie<br />
        if (!isset(&#36;_COOKIE[&#36;_CONF['cookie_name']]) || !isset(&#36;_COOKIE['password'])) &#123;<br />
            // Either their cookie expired or they are new<br />
            &#36;cooktime = COM_getUserCookieTimeout();<br />
            if (&#36;VERBOSE) &#123;<br />
                COM_errorLog(&quot;Trying to set permanent cookie with time of &#36;cooktime&quot;,1);<br />
            &#125;<br />
            if (&#36;cooktime &gt; 0) &#123;<br />
                // They want their cookie to persist for some amount of time so set it now<br />
                if (&#36;VERBOSE) &#123;<br />
                    COM_errorLog('Trying to set permanent cookie',1);<br />
                &#125;<br />
                setcookie (&#36;_CONF['cookie_name'], &#36;_USER['uid'],<br />
                           time() + &#36;cooktime, &#36;_CONF['cookie_path'],<br />
                           &#36;_CONF['cookiedomain'], &#36;_CONF['cookiesecure']);<br />
                setcookie (&#36;_CONF['cookie_password'],<br />
                           SEC_encryptPassword(&#36;passwd), time() + &#36;cooktime,<br />
                           &#36;_CONF['cookie_path'], &#36;_CONF['cookiedomain'],<br />
                           &#36;_CONF['cookiesecure']);<br />
            &#125;<br />
        &#125; else &#123;<br />
            &#36;userid = &#36;_COOKIE[&#36;_CONF['cookie_name']];<br />
            if (empty (&#36;userid) || (&#36;userid == 'deleted')) &#123;<br />
                unset (&#36;userid);<br />
            &#125; else &#123;<br />
                &#36;userid = COM_applyFilter (&#36;userid, true);<br />
                if (&#36;userid &gt; 1) &#123;<br />
                    if (&#36;VERBOSE) &#123;<br />
                        COM_errorLog ('NOW trying to set permanent cookie',1);<br />
                        COM_errorLog ('Got '.&#36;userid.' from perm cookie in users.php',1);<br />
                    &#125;<br />
                    // Create new session<br />
                    &#36;userdata = SESS_getUserDataFromId (&#36;userid);<br />
                    &#36;_USER = &#36;userdata;<br />
                    if (&#36;VERBOSE) &#123;<br />
                        COM_errorLog ('Got '.&#36;_USER['username'].' for the username in user.php',1);<br />
                    &#125;<br />
                &#125;<br />
            &#125;<br />
        &#125;<br />
<br />
        // Now that we have users data see if their theme cookie is set.<br />
        // If not set it<br />
        setcookie (&#36;_CONF['cookie_theme'], &#36;_USER['theme'], time() + 31536000,<br />
                   &#36;_CONF['cookie_path'], &#36;_CONF['cookiedomain'],<br />
                   &#36;_CONF['cookiesecure']);<br />
<br />
        if (!empty(&#36;_SERVER['HTTP_REFERER'])<br />
                &amp;&amp; (strstr(&#36;_SERVER['HTTP_REFERER'], '/users.php') === false)<br />
                &amp;&amp; (substr(&#36;_SERVER['HTTP_REFERER'], 0,<br />
                        strlen(&#36;_CONF['site_url'])) == &#36;_CONF['site_url'])) &#123;<br />
            &#36;indexMsg = &#36;_CONF['site_url'] . '/index.php?msg=';<br />
            if (substr (&#36;_SERVER['HTTP_REFERER'], 0, strlen (&#36;indexMsg)) == &#36;indexMsg) &#123;<br />
                &#36;display .= COM_refresh (&#36;_CONF['site_url'] . '/index.php');<br />
            &#125; else &#123;<br />
                // If user is trying to login - force redirect to index.php<br />
                if (strstr (&#36;_SERVER['HTTP_REFERER'], 'mode=login') === false) &#123;<br />
                    &#36;display .= COM_refresh (&#36;_SERVER['HTTP_REFERER']);<br />
                &#125; else &#123;<br />
                    &#36;display .= COM_refresh (&#36;_CONF['site_url'] . '/index.php');<br />
                &#125;<br />
            &#125;<br />
        &#125; else &#123;<br />
            &#36;display .= COM_refresh (&#36;_CONF['site_url'] . '/index.php');<br />
        &#125;<br />
    &#125; else &#123;<br />
        // On failed login attempt, update speed limit<br />
        COM_updateSpeedlimit('login');<br />
<br />
        &#36;display .= COM_siteHeader('menu');<br />
<br />
        if (isset (&#36;_REQUEST['msg'])) &#123;<br />
            &#36;msg = COM_applyFilter (&#36;_REQUEST['msg'], true);<br />
        &#125; else &#123;<br />
            &#36;msg = 0;<br />
        &#125;<br />
        if (&#36;msg &gt; 0) &#123;<br />
            &#36;display .= COM_showMessage(&#36;msg);<br />
        &#125;<br />
<br />
        switch (&#36;mode) &#123;<br />
        case 'create':<br />
            // Got bad account info from registration process, show error<br />
            // message and display form again<br />
            if (&#36;_CONF['custom_registration'] AND (function_exists('CUSTOM_userForm'))) &#123;<br />
                &#36;display .= CUSTOM_userForm ();<br />
            &#125; else &#123;<br />
                &#36;display .= newuserform ();<br />
            &#125;<br />
            break;<br />
        default:<br />
            // check to see if this was the last allowed attempt<br />
            if (COM_checkSpeedlimit('login', &#36;_CONF['login_attempts']) &gt; 0) &#123;<br />
                displayLoginErrorAndAbort(82, &#36;LANG04[113], &#36;LANG04[112]);<br />
            &#125; else &#123; // Show login form<br />
                if((&#36;msg != 69) &amp;&amp; (&#36;msg != 70)) &#123;<br />
                    if (&#36;_CONF['custom_registration'] AND function_exists('CUSTOM_loginErrorHandler')) &#123;<br />
                        // Typically this will be used if you have a custom main site page and need to control the login process<br />
                        &#36;display .= CUSTOM_loginErrorHandler(&#36;msg);<br />
                    &#125; else &#123;<br />
                        &#36;display .= loginform(false, &#36;status);<br />
                    &#125;<br />
                &#125;<br />
            &#125;<br />
            break;<br />
        &#125;<br />
<br />
        &#36;display .= COM_siteFooter();<br />
    &#125;<br />
    break;<br />
&#125;<br />
<br />
echo &#36;display;<br />
<br />
?&gt;<br />

    </div>
    <div class="story-footer">
        <p></p>
        <p> <a href="http://localhost/geeklog-15/public_html/comment.php?sid=20080722230307779&amp;pid=0&amp;type=article" rel="nofollow">コメント投稿</a></p>
        <p>コメント (0件) トラックバック (0件)</p>
    </div>
</div>
<div class="block-divider"> </div>
<div class="story">
    <span class="story-icons">
        <a href="http://localhost/geeklog-15/public_html/profiles.php?sid=2008072123542416&amp;what=emailstory"><img src="http://localhost/geeklog-15/public_html/layout/professional/images/mail.png" alt="記事を友人にメールする" title="友だちに記事をメールする"></a>
        <a href="http://localhost/geeklog-15/public_html/article.php?story=2008072123542416&amp;mode=print" rel="nofollow"><img src="http://localhost/geeklog-15/public_html/layout/professional/images/print.png" alt="印刷用画面" title="印刷用ページ"></a>
        
        <a href="http://localhost/geeklog-15/public_html/admin/story.php?mode=edit&amp;sid=2008072123542416"><img src="http://localhost/geeklog-15/public_html/layout/professional/images/edit.png" alt="編集" title="編集"></a>
    </span>
    <h1><a href="http://localhost/geeklog-15/public_html/article.php?story=2008072123542416" class="non-ul">リンクテスト</a></h1>
    <div class="story-information">
        <p>Monday, July 21 2008 @ 11:54 PM JST</p>
        <p>投稿者: <a href="http://localhost/geeklog-15/public_html/users.php?mode=profile&amp;uid=2" class="storybyline">Admin</a></p>
        <p>閲覧件数 0</p>
    </div>
    <div class="story-body">
        <a href="http://localhost/geeklog-15/public_html/index.php?topic=Geeklog" rel="category tag"><img src="http://localhost/geeklog-15/public_html/images/topics/topic_gl.gif" class="floatright" alt="Geeklog" title="Geeklog"></a>url=&quot;<a href="http://mystral-kk.net/&quot">http://mystral-kk.net/&quot</a>;<br />

    </div>
    <div class="story-footer">
        <p></p>
        <p> <a href="http://localhost/geeklog-15/public_html/comment.php?sid=2008072123542416&amp;pid=0&amp;type=article" rel="nofollow">コメント投稿</a></p>
        <p>コメント (0件) トラックバック (0件)</p>
    </div>
</div>
<div class="block-divider"> </div>
<div class="story">
    <span class="story-icons">
        <a href="http://localhost/geeklog-15/public_html/profiles.php?sid=20080713165029471&amp;what=emailstory"><img src="http://localhost/geeklog-15/public_html/layout/professional/images/mail.png" alt="記事を友人にメールする" title="友だちに記事をメールする"></a>
        <a href="http://localhost/geeklog-15/public_html/article.php?story=20080713165029471&amp;mode=print" rel="nofollow"><img src="http://localhost/geeklog-15/public_html/layout/professional/images/print.png" alt="印刷用画面" title="印刷用ページ"></a>
        
        <a href="http://localhost/geeklog-15/public_html/admin/story.php?mode=edit&amp;sid=20080713165029471"><img src="http://localhost/geeklog-15/public_html/layout/professional/images/edit.png" alt="編集" title="編集"></a>
    </span>
    <h1><a href="http://localhost/geeklog-15/public_html/article.php?story=20080713165029471" class="non-ul">放置プレー16:50より</a></h1>
    <div class="story-information">
        <p>Sunday, July 13 2008 @ 04:50 PM JST</p>
        <p>投稿者: <a href="http://localhost/geeklog-15/public_html/users.php?mode=profile&amp;uid=2" class="storybyline">Admin</a></p>
        <p>閲覧件数 0</p>
    </div>
    <div class="story-body">
        <a href="http://localhost/geeklog-15/public_html/index.php?topic=Geeklog" rel="category tag"><img src="http://localhost/geeklog-15/public_html/images/topics/topic_gl.gif" class="floatright" alt="Geeklog" title="Geeklog"></a><p>放置プレー16:50より。story.php対策後。</p>
    </div>
    <div class="story-footer">
        <p></p>
        <p> <a href="http://localhost/geeklog-15/public_html/comment.php?sid=20080713165029471&amp;pid=0&amp;type=article" rel="nofollow">コメント投稿</a></p>
        <p>コメント (0件) トラックバック (0件)</p>
    </div>
</div>
<div class="block-divider"> </div>
            <!-- End Content Area -->
            </td>
            <!-- Start of Right Blocks -->
<td class="block-outerborder-right">
    <div style="background:transparent; width:1px; height:1px;"></div>
</td>
<td class="block-featured-right" style="vertical-align:top;">
    <div class="block-bg-right">
            <div class="block-box-right">
    <span class="block-helpicon">
        
    </span>
    <h2>Who's Online</h2><a href="http://localhost/geeklog-15/public_html/users.php?mode=profile&amp;uid=2">Admin</a><br></div>
<div class="aligncenter">
    <div class="block-divider-right"></div>
</div>
<div class="block-box-right">
    <span class="block-helpicon">
        
    </span>
    <h2>Poll</h2><span class="floatright"><a href="http://localhost/geeklog-15/public_html/admin/plugins/polls/index.php?mode=edit&amp;pid=geeklogfeaturepoll"><img src="http://localhost/geeklog-15/public_html/layout/professional/images/edit.png" title="編集" alt="編集"></a></span><div class="poll-topic">Tell us your opinion about Geeklog</div>
<form action="http://localhost/geeklog-15/public_html/polls/index.php" name="Vote" method="post">
    <div>
    <input type="hidden" name="pid" value="geeklogfeaturepoll">
            <div class="poll-questions">
    <p class="poll-question"> What is the best new feature of Geeklog?</p>
    <ul>
      <li><input type="radio" name="aid[0]" value="1">&nbsp;MS SQL support</li>
  <li><input type="radio" name="aid[0]" value="2">&nbsp;Multi-language support</li>
  <li><input type="radio" name="aid[0]" value="3">&nbsp;Calendar as a plugin</li>
  <li><input type="radio" name="aid[0]" value="4">&nbsp;SLV spam protection</li>
  <li><input type="radio" name="aid[0]" value="5">&nbsp;Mass-delete users</li>
  <li><input type="radio" name="aid[0]" value="6">&nbsp;Other</li>

    </ul>
</div>
        <span class="pluginTinyText">このアンケートにはさらにもう 1 件，質問があります。</span><br>
        <input type="submit" value="投票する">
        <a href="http://localhost/geeklog-15/public_html/polls/index.php?pid=geeklogfeaturepoll&amp;aid=-1">結果</a>
    </div>
</form>

<span class="pluginTinyText">
    <a href="http://localhost/geeklog-15/public_html/polls/index.php">他のアンケートを見る</a> | 0 投票  | <a href="http://localhost/geeklog-15/public_html/polls/index.php?pid=geeklogfeaturepoll#comments">0 件のコメント</a>

</span>
</div>
<div class="aligncenter">
    <div class="block-divider-right"></div>
</div>
<div class="block-box-right">
    <span class="block-helpicon">
        
    </span>
    <h2>What's New</h2><h3>記事</h3>-<br><br><h3>コメント <small>(2日)</small></h3>  -<br>
<br><h3>トラックバック <small>(2日)</small></h3>-<br>
<br><h3>リンク <small>(2週)</small></h3>新しいリンクはありません<br>
</div>
<div class="aligncenter">
    <div class="block-divider-right"></div>
</div>

            <div class="block-bg-spreader"></div>
    </div>
</td>
<!--</td></tr></table>-->
<!--If you want the splash, uncomment the last line. If you want no splash, make sure it is commented out.-->

        </tr>
    </table>
    
    <table cellpadding="0" cellspacing="0" width="100%" class="footer-divider-top">
        <tr>
            <td class="footerblock alignleft" style="width:70%;">
                &nbsp;Copyright &copy; 2008 Geeklog Site<br>&nbsp;本ページのすべての商標と著作権はそれぞれの所有者に帰属します。
            </td>
            <td class="footerblock alignright" style="width:30%;">
                Powered By <a href="http://www.geeklog.net/">Geeklog</a>&nbsp;<br>ページ作成時間 1.35 秒&nbsp;
            </td>
        </tr>
    </table>
</body>
</html>
